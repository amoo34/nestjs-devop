name: Deploy to Google Cloud Run

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: us-central1 # Change to your preferred region
  SERVICE: nest-test-devop
  REGION: us-central1 # Change to your preferred region
  # Supabase Postgres connection string
  DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    # Only deploy if CI passes (optional - remove if you want independent deployment)
    # needs: [lint, test, build]
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Create Service Account Key File from Secret
        run: |
          # Write the secret to a file with the same name as your local file
          echo '${{ secrets.GCP_SA_KEY }}' > eng-plasma-481303-g9-93823deed054.json
          chmod 600 eng-plasma-481303-g9-93823deed054.json
          echo "âœ… Service account key file created: eng-plasma-481303-g9-93823deed054.json"
      
      - name: Authenticate to Google Cloud using Service Account File
        run: |
          gcloud auth activate-service-account --key-file=eng-plasma-481303-g9-93823deed054.json
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          echo "âœ… Authenticated to GCP using eng-plasma-481303-g9-93823deed054.json"
      
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker $GAR_LOCATION-docker.pkg.dev --quiet
      
      - name: Build Docker image
        run: |
          docker build -t $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$SERVICE/$SERVICE:$GITHUB_SHA \
            -t $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$SERVICE/$SERVICE:latest .
      
      - name: Push Docker image to Artifact Registry
        run: |
          docker push $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$SERVICE/$SERVICE:$GITHUB_SHA
          docker push $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$SERVICE/$SERVICE:latest
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE \
            --image $GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$SERVICE/$SERVICE:$GITHUB_SHA \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --set-env-vars "PORT=8080,DATABASE_URL=$DATABASE_URL" \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10
      
      - name: Get service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE --region=$REGION --format='value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ğŸš€ Service deployed to: $SERVICE_URL"
      
      - name: Output service URL
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Service URL: ${{ steps.get-url.outputs.url }}"

